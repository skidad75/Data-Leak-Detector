import streamlit as st
import socket
import re

try:
    import nmap
    NMAP_AVAILABLE = True
except ImportError:
    NMAP_AVAILABLE = False

def is_valid_domain(domain):
    pattern = r"^(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}$"
    return re.match(pattern, domain) is not None

def is_valid_ip(ip):
    try:
        socket.inet_aton(ip)
        return True
    except socket.error:
        return False

def perform_vulnerability_scan(target):
    if not NMAP_AVAILABLE:
        st.error("The python-nmap library is not installed. Unable to perform scan.")
        return None

    nm = nmap.PortScanner()
    try:
        # Run nmap scan with vulners script
        result = nm.scan(hosts=target, arguments="-sV --script vulners")
        
        vulnerabilities = []
        
        for host in result['scan']:
            for port in result['scan'][host]['tcp']:
                port_info = result['scan'][host]['tcp'][port]
                if 'script' in port_info and 'vulners' in port_info['script']:
                    vulners_info = port_info['script']['vulners']
                    vulnerabilities.append({
                        'port': port,
                        'service': port_info['name'],
                        'version': port_info['version'],
                        'vulnerabilities': vulners_info
                    })
        
        return vulnerabilities
    except Exception as e:
        st.error(f"An error occurred during the scan: {str(e)}")
        return None

st.title("Vulnerability Scanner")

st.warning("⚠️ This tool is for educational purposes only. Do not use on systems you don't own or have explicit permission to test.")

if not NMAP_AVAILABLE:
    st.error("The python-nmap library is not installed. Please install it to use this feature.")
    st.info("You can install python-nmap using pip: `pip install python-nmap`")
else:
    target = st.text_input("Enter a domain or IP address to scan:")

    if st.button("Scan for Vulnerabilities"):
        if target:
            if is_valid_domain(target) or is_valid_ip(target):
                with st.spinner("Scanning for vulnerabilities... This may take a few minutes."):
                    vulnerabilities = perform_vulnerability_scan(target)
                    
                    if vulnerabilities:
                        st.subheader("Scan Results")
                        for vuln in vulnerabilities:
                            st.write(f"Port: {vuln['port']}")
                            st.write(f"Service: {vuln['service']}")
                            st.write(f"Version: {vuln['version']}")
                            st.write("Vulnerabilities:")
                            st.code(vuln['vulnerabilities'])
                            st.write("---")
                    else:
                        st.info("No vulnerabilities found or unable to complete the scan.")
            else:
                st.error("Invalid domain or IP address. Please enter a valid target.")
        else:
            st.error("Please enter a domain or IP address to scan.")

st.sidebar.warning("Note: This scanner uses the nmap vulners script. Ensure you have the necessary permissions to perform scans on the target system.")